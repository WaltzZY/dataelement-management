# 自动化测试系统架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端层 (Vue.js 3)                        │
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ API列表  │  │ 测试用例  │  │ 执行结果  │  │ 统计面板  │      │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘      │
│       │             │             │             │              │
│       └─────────────┴─────────────┴─────────────┘              │
│                         │                                       │
│                         │ HTTP/REST API                         │
└─────────────────────────┼───────────────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────────────┐
│                         ▼                                       │
│                  AutoTestController                             │
│                  (REST API接口层)                               │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  GET  /autotest/apis           - 扫描所有API            │  │
│  │  POST /autotest/testcases/generate - 生成测试用例       │  │
│  │  POST /autotest/execute        - 执行测试用例           │  │
│  │  GET  /autotest/results        - 获取测试结果           │  │
│  │  GET  /autotest/statistics     - 获取统计信息           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                         │                                       │
│         ┌───────────────┼───────────────┐                      │
│         ▼               ▼               ▼                      │
│  ┌──────────┐   ┌─────────────┐  ┌──────────┐                │
│  │ApiScanner│   │TestData     │  │ApiExecutor│                │
│  │          │   │Generator    │  │          │                │
│  │扫描API   │   │生成测试数据  │  │执行接口  │                │
│  └────┬─────┘   └──────┬──────┘  └────┬─────┘                │
│       │                │              │                        │
│       │                │              │                        │
│       │                ▼              │                        │
│       │         ┌────────────┐        │                        │
│       │         │  Database  │        │                        │
│       │         │  (MySQL)   │        │                        │
│       │         │            │        │                        │
│       │         │ 采样真实数据│        │                        │
│       │         └────────────┘        │                        │
│       │                               │                        │
│       └───────────┬───────────────────┘                        │
│                   ▼                                            │
│           ┌───────────────┐                                    │
│           │JsonStorage    │                                    │
│           │Manager        │                                    │
│           │               │                                    │
│           │JSON文件存储    │                                    │
│           └───────┬───────┘                                    │
│                   │                                            │
└───────────────────┼────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  autotest-data/       │
        │                       │
        │  ├── testcases/       │
        │  │   └── *.json       │
        │  │                    │
        │  └── results/         │
        │      └── *.json       │
        └───────────────────────┘
```

## 模块说明

### 1. 前端层 (Vue.js 3 + Element Plus)

**文件位置:** `src/main/resources/static/autotest/index.html`

**功能模块:**
- **API列表管理** - 显示所有扫描到的API接口,支持单个/批量生成测试用例
- **测试用例查看** - 展示所有生成的测试用例,按API分组
- **执行结果查看** - 显示测试执行历史和详细结果
- **统计面板** - 实时显示关键指标统计

**技术栈:**
- Vue 3 (Composition API)
- Element Plus (UI组件库)
- Axios (HTTP客户端)

### 2. 控制器层

**文件:** `AutoTestController.java`

**职责:**
- 提供RESTful API接口
- 协调各个模块的调用
- 处理HTTP请求和响应
- 统一异常处理

**核心接口:**
| 接口 | 功能 |
|------|------|
| `/autotest/apis` | 扫描所有API接口 |
| `/autotest/testcases/generate` | 生成测试用例 |
| `/autotest/execute` | 执行测试 |
| `/autotest/results` | 查询结果 |
| `/autotest/statistics` | 统计信息 |

### 3. API扫描器 (ApiScanner)

**文件:** `ApiScanner.java`

**功能:**
- 扫描所有带`@RestController`注解的类
- 解析`@RequestMapping`、`@GetMapping`、`@PostMapping`等注解
- 提取API路径、HTTP方法、参数类型、返回值类型
- 生成`ApiInfo`对象列表

**技术实现:**
- 使用Spring的`ApplicationContext`获取所有Bean
- 使用Java反射解析类和方法
- 使用Spring注解工具类`AnnotatedElementUtils`

### 4. 测试数据生成器 (TestDataGenerator)

**文件:** `TestDataGenerator.java`

**功能:**
- 根据API参数类型生成测试数据
- 从数据库采样真实数据
- 生成多样化的测试场景
- 支持自定义数据生成策略

**数据生成策略:**

#### 分页查询类 (DataElementPageQueryDto)
- 基础分页查询
- 边界值测试(大页码、大分页)
- 关键词搜索(从数据库采样)
- 状态筛选(使用真实状态)
- 数源单位筛选(使用真实单位代码)
- 组合条件查询
- 排序测试(升序/降序)

#### 手动定源类 (ManualConfirmUnitDto)
- 正常定源(使用真实dataid)
- 异常测试(不存在的ID)

#### 通用API
- 空参数请求
- 基础参数请求

**数据来源:**
- 从`BaseDataElementMapper`读取真实数据
- 随机采样和组合
- 生成边界值和异常值

### 5. 接口执行器 (ApiExecutor)

**文件:** `ApiExecutor.java`

**功能:**
- 执行测试用例
- 调用实际的REST API接口
- 记录请求和响应
- 计算响应时间
- 处理异常情况

**技术实现:**
- 使用Spring的`RestTemplate`
- 支持GET/POST/PUT/DELETE方法
- 自动处理JSON序列化
- 异常捕获和记录

**执行流程:**
```
1. 读取测试用例
2. 构建HTTP请求
3. 发送请求到本地服务器
4. 记录开始时间
5. 接收响应
6. 计算响应时间
7. 判断成功/失败
8. 保存执行结果
```

### 6. JSON存储管理器 (JsonStorageManager)

**文件:** `JsonStorageManager.java`

**功能:**
- 测试用例的读写
- 执行结果的读写
- 统计信息计算
- JSON文件管理

**存储结构:**
```
autotest-data/
├── testcases/
│   ├── testcase_business_allDataElement_getAllDataElementPage.json
│   ├── testcase_business_allDataElement_exportDataElementList.json
│   └── ...
└── results/
    ├── results_20251103.json
    ├── results_20251104.json
    └── ...
```

**技术实现:**
- 使用Jackson进行JSON序列化
- 支持Java 8时间类型
- 按日期分文件存储执行结果
- 自动创建目录

### 7. 数据模型

**模型类:**

| 类名 | 说明 |
|------|------|
| `ApiInfo` | API接口信息 |
| `TestCase` | 单个测试用例 |
| `TestCaseCollection` | 测试用例集合 |
| `TestExecutionResult` | 测试执行结果 |

**关键字段:**

**ApiInfo:**
- apiPath - API路径
- httpMethod - HTTP方法
- controllerClass - 控制器类名
- methodName - 方法名
- requestParamType - 参数类型
- hasTestCases - 是否有测试用例

**TestCase:**
- id - 用例ID
- description - 用例描述
- requestParams - 请求参数(Map)
- dataSource - 数据来源
- enabled - 是否启用

**TestExecutionResult:**
- testCaseId - 关联的测试用例ID
- executeTime - 执行时间
- responseStatus - HTTP状态码
- responseBody - 响应内容
- responseTime - 响应时间(毫秒)
- success - 是否成功
- errorMessage - 错误信息

## 数据流转

### 生成测试用例流程

```
1. 前端点击"生成用例"
   ↓
2. 调用 POST /autotest/testcases/generate
   ↓
3. AutoTestController 接收请求
   ↓
4. 调用 TestDataGenerator.generateTestCases()
   ↓
5. TestDataGenerator 查询数据库采样数据
   ↓
6. 根据参数类型生成测试用例
   ↓
7. 调用 JsonStorageManager.saveTestCaseCollection()
   ↓
8. 写入 autotest-data/testcases/*.json
   ↓
9. 返回生成的测试用例集合给前端
```

### 执行测试用例流程

```
1. 前端点击"执行测试"
   ↓
2. 调用 POST /autotest/execute?apiPath=xxx
   ↓
3. AutoTestController 接收请求
   ↓
4. 调用 ApiExecutor.executeTestCasesByApi()
   ↓
5. ApiExecutor 加载测试用例
   ↓
6. 使用 RestTemplate 调用实际API接口
   ↓
7. 记录请求参数、响应内容、响应时间
   ↓
8. 构建 TestExecutionResult 对象
   ↓
9. 调用 JsonStorageManager.saveTestExecutionResult()
   ↓
10. 写入 autotest-data/results/*.json
   ↓
11. 返回执行结果列表给前端
```

## 扩展点

### 1. 添加新的数据生成策略

在`TestDataGenerator.java`中:

```java
private List<TestCase> generateCustomTestCases(ApiInfo apiInfo) {
    // 实现自定义数据生成逻辑
}
```

然后在`generateTestCases()`方法中根据参数类型调用:

```java
if (paramType.contains("CustomDto")) {
    testCases.addAll(generateCustomTestCases(apiInfo));
}
```

### 2. 支持新的数据源

可以注入其他Mapper,从不同的数据表采样数据:

```java
@Autowired
private OrganizationUnitMapper organizationUnitMapper;

// 从organization_unit表采样数据
List<OrganizationUnit> units = organizationUnitMapper.selectList(null);
```

### 3. 自定义统计维度

在`JsonStorageManager.java`中添加新的统计方法:

```java
public Map<String, Object> getCustomStatistics() {
    // 实现自定义统计逻辑
}
```

### 4. 添加断言验证

在`ApiExecutor.java`中可以添加响应验证逻辑:

```java
// 验证响应内容是否符合预期
boolean isValid = validateResponse(response, expectedResult);
result.setSuccess(isValid);
```

## 技术栈总结

**后端:**
- Spring Boot 2.6.7
- MyBatis-Plus 3.5.7
- Jackson (JSON处理)
- Java 8 (反射、Stream API)

**前端:**
- Vue 3 (渐进式框架)
- Element Plus (UI组件)
- Axios (HTTP客户端)

**存储:**
- JSON文件 (测试用例和结果)
- MySQL (真实数据采样)

**工具:**
- Lombok (简化代码)
- SLF4J (日志)

## 性能考虑

1. **批量执行** - 每次请求之间延迟100ms,避免服务器压力过大
2. **分页加载** - 前端表格支持分页,避免一次加载过多数据
3. **按日期分文件** - 执行结果按日期存储,避免单个文件过大
4. **异步处理** - 可以考虑将批量执行改为异步任务

## 安全考虑

1. **CORS配置** - 仅在开发环境开启,生产环境应配置白名单
2. **权限控制** - 可以添加Spring Security进行权限验证
3. **数据隔离** - 生产环境应使用独立的测试数据库
4. **敏感信息** - 避免在测试用例中包含敏感数据

## 未来优化方向

1. **定时任务** - 支持定时自动执行测试
2. **邮件通知** - 测试失败时发送邮件通知
3. **对比分析** - 对比不同时间段的测试结果
4. **性能测试** - 支持并发测试和压力测试
5. **Mock数据** - 支持不依赖数据库的Mock数据生成
6. **测试报告** - 生成HTML/PDF格式的测试报告
